{% extends 'home.html' %}
{% load widget_tweaks %}
{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="card">
    <div class="card-body">
        <center><h3>Editar Información del Usuario</h3></center>
        <form method="post" action="{% url 'user_info:user_edit' request.user.id %}" id="edit-form">
            {% csrf_token %}
            
            <!-- Campo de nombre de usuario -->
            <div class="form-group">
                {{ EditUserInfo.username.label_tag }}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                    </div>
                    {{ EditUserInfo.username }}
                </div>
            </div>
        
            <!-- Campo de nombre -->
            <div class="form-group">
                {{ EditUserInfo.first_name.label_tag }}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                    </div>
                    {{ EditUserInfo.first_name }}
                </div>
            </div>
        
            <!-- Campo de apellido -->
            <div class="form-group">
                {{ EditUserInfo.last_name.label_tag }}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-user-friends"></i></span>
                    </div>
                    {{ EditUserInfo.last_name }}
                </div>
            </div>
        
            <!-- Campo de contraseña -->
            <div class="form-group">
                {{ EditUserInfo.password.label_tag }}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    </div>
                    {{ EditUserInfo.password }}
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" id="toggle-password">
                            <i class="fas fa-eye" id="password-icon"></i>
                        </button>
                    </div>
                </div>
            </div>
        
            <!-- Campo de confirmación de contraseña -->
            <div class="form-group">
                {{ EditUserInfo.password2.label_tag }}
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    </div>
                    {{ EditUserInfo.password2 }}
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" id="toggle-password2">
                            <i class="fas fa-eye" id="password-icon2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </form>
    </div>
</div>
<!-- <script>
    document.getElementById('toggle-password').addEventListener('click', function () {
        var passwordField = document.getElementById('id_password');
        var passwordFieldType = passwordField.getAttribute('type');
        if (passwordFieldType === 'password') {
            passwordField.setAttribute('type', 'text');
            this.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            passwordField.setAttribute('type', 'password');
            this.innerHTML = '<i class="fas fa-eye"></i>';
        }
    });
</script> -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userId = "{{ request.user.id }}"; // Obtén el ID del usuario autenticado desde el contexto de Django

        // Cambia dinámicamente el atributo 'action' del formulario
        document.getElementById('edit-form').setAttribute('action', `/user_info/user_edit/${userId}/`);

        // Si necesitas realizar otras acciones, como rellenar campos, puedes hacerlo aquí
        fetch(`/user_info/get_user_data/${userId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_username').value = data.username;
            // Nota: No es seguro rellenar el campo de contraseña con datos sensibles
        })
        .catch(error => {
            console.error('Error al obtener los datos del usuario:', error);
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userId = "{{ request.user.id }}"; // Obtén el ID del usuario autenticado desde el contexto de Django

        // Cambia dinámicamente el atributo 'action' del formulario
        document.getElementById('edit-form').setAttribute('action', `/user_info/user_edit/${userId}/`);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('edit-form');

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Evita el envío inmediato del formulario

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas guardar los cambios realizados?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(
                        '¡Guardado!',
                        'La información del usuario se ha actualizado correctamente.',
                        'success'
                    ).then(() => {
                        form.submit(); // Envía el formulario después de la confirmación
                    });
                }
            });
        });
    });
</script>
<!-- script funcionalidad del ojo V.Parra -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const togglePassword = document.getElementById('toggle-password');
        const passwordField = document.getElementById('edit_password');
        const passwordIcon = document.getElementById('password-icon');

        togglePassword.addEventListener('click', function () {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            passwordIcon.classList.toggle('fa-eye');
            passwordIcon.classList.toggle('fa-eye-slash');
        });

        const togglePassword2 = document.getElementById('toggle-password2');
        const passwordField2 = document.getElementById('edit_password2');
        const passwordIcon2 = document.getElementById('password-icon2');

        togglePassword2.addEventListener('click', function () {
            const type = passwordField2.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField2.setAttribute('type', type);
            passwordIcon2.classList.toggle('fa-eye');
            passwordIcon2.classList.toggle('fa-eye-slash');
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('edit-form');
        const passwordField = document.getElementById('edit_password');
        const confirmPasswordField = document.getElementById('edit_password2');

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Evita el envío inmediato del formulario

            // Verifica si las contraseñas coinciden
            if (passwordField.value !== confirmPasswordField.value) {
                Swal.fire({
                    icon: 'error',
                    title: '¡Error!',
                    text: 'Las contraseñas no coinciden. Por favor, verifica e inténtalo de nuevo.',
                    confirmButtonText: 'Aceptar'
                });
                return; // Detiene el proceso de envío
            }

            // Si las contraseñas coinciden, muestra el mensaje de confirmación
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas guardar los cambios realizados?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(
                        '¡Guardado!',
                        'La información del usuario se ha actualizado correctamente.',
                        'success'
                    ).then(() => {
                        form.submit(); // Envía el formulario después de la confirmación
                    });
                }
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('edit-form');
        const passwordField = document.getElementById('edit_password');
        const confirmPasswordField = document.getElementById('edit_password2');
        const usernameField = document.getElementById('edit_username');
        const firstNameField = document.getElementById('edit_first_name');
        const lastNameField = document.getElementById('edit_last_name');

        // Guarda los valores iniciales de los campos
        const initialValues = {
            username: usernameField.value.trim(),
            firstName: firstNameField.value.trim(),
            lastName: lastNameField.value.trim()
        };

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const password = passwordField.value.trim();
            const confirmPassword = confirmPasswordField.value.trim();
            const username = usernameField.value.trim();
            const firstName = firstNameField.value.trim();
            const lastName = lastNameField.value.trim();

            // Verifica si los campos de contraseña están vacíos
            if (password === '' && confirmPassword === '') {
                // Verifica si otros campos han cambiado
                if (
                    username !== initialValues.username ||
                    firstName !== initialValues.firstName ||
                    lastName !== initialValues.lastName
                ) {
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "¿Deseas guardar los cambios realizados?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, guardar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire(
                                '¡Guardado!',
                                'La información del usuario se ha actualizado correctamente.',
                                'success'
                            ).then(() => {
                                form.submit(); // Envía el formulario después de la confirmación
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Sin cambios',
                        text: 'No se detectaron cambios en los campos.',
                        confirmButtonText: 'Aceptar'
                    });
                }
                return;
            }

            // Valida la contraseña solo si se ha proporcionado
            const passwordRegex = /^(?=.*[!@#$%^&*(),.?":{}|<>])[A-Za-z\d!@#$%^&*(),.?":{}|<>]{8,}$/;
            if (password !== '' && !passwordRegex.test(password)) {
                Swal.fire({
                    icon: 'error',
                    title: '¡Error!',
                    text: 'La contraseña debe tener al menos 8 caracteres y un carácter especial.',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Verifica si las contraseñas coinciden
            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: '¡Error!',
                    text: 'Las contraseñas no coinciden. Por favor, verifica e inténtalo de nuevo.',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // Si todo está correcto, muestra la confirmación
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas guardar los cambios realizados?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire(
                        '¡Guardado!',
                        'La información del usuario se ha actualizado correctamente.',
                        'success'
                    ).then(() => {
                        form.submit();
                    });
                }
            });
        });
    });
</script>
{% endblock %}